---
title: Обнаружение и исправление правил Outlook и внедрений пользовательских форм в Office 365
ms.author: chrfox
author: chrfox
manager: laurawi
ms.date: 04/23/2018
audience: ITPro
ms.topic: article
ms.collection:
- o365_security_incident_response
- M365-security-compliance
ms.service: O365-seccomp
localization_priority: Normal
search.appverid:
- MET150
description: Сведения о том, как распознать и исправить правила Outlook и функции внедрения пользовательских форм в Office 365
ms.openlocfilehash: ef2f08c953b91ccefcadd5947d2d0a9f39683ae2
ms.sourcegitcommit: 9d67cb52544321a430343d39eb336112c1a11d35
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/17/2019
ms.locfileid: "34150261"
---
# <a name="detect-and-remediate-outlook-rules-and-custom-forms-injections-attacks-in-office-365"></a>Обнаружение атак с внедрением правил и пользовательских форм Outlook и устранение их последствий в Office 365

**Сводка** Сведения о том, как распознать и исправить правила Outlook и функции внедрения пользовательских форм в Office 365.

## <a name="what-is-the-outlook-rules-and-custom-forms-injection-attack"></a>Что такое "правила Outlook" и "атака с помощью пользовательских форм"?
После нарушения учетной записи в вашем клиенте и ее появления, вы можете попытаться вернуться и вернуть его после обнаружения и удаления. Это называется установкой механизма сохранения. Это можно сделать двумя способами: с помощью правил Outlook или путем добавления настраиваемых форм в Outlook.
В обоих случаях правило или форма синхронизируются от облачной службы к клиентскому рабочему столу, поэтому полный формат и повторная установка клиентского программного обеспечения не устраняют механизм внедрения. Это связано с тем, что когда клиентское программное обеспечение Outlook повторно подключается к почтовому ящику в облаке, будут повторно загружены правила и формы из облака. Когда правила и формы будут готовы, злоумышленник использует их для выполнения удаленного или пользовательского кода, как правило, для установки вредоносных программ на локальном компьютере. Вредоносные программы повторно заменяют учетные данные или выполняют другие незаконные действия. Хорошая новость заключается в том, что если вы захотите, чтобы ваши клиенты были обновлены до последней версии, вы не подвержены воздействию угроз как текущие клиенты Outlook по умолчанию блокируют оба этих механизма. 

Как правило, атаки выполняются по следующим шаблонам:

Правила использования
1. Злоумышленник получает имя пользователя и пароль одного из пользователей.
2. Затем злоумышленник подписывается на почтовый ящик Exchange пользователя. Почтовый ящик может находиться в Exchange Online или в локальной среде Exchange.
3. Затем злоумышленник создает правило пересылки в почтовом ящике, которое запускается, когда почтовый ящик получает сообщение электронной почты, которое соответствует условиям правила. Критерии правила и содержимого для триггерной электронной почты настроены для друг друга.
4. Злоумышленник отправляет сообщение электронной почты пользователю, который использует свой почтовый ящик обычным образом.
5. При получении сообщения электронной почты запускается правило. Действие правила обычно запускает приложение на удаленном сервере (WebDAV).
6. Приложение обычно устанавливает вредоносные программы, такие как [PowerShell емпире](https://www.powershellempire.com/), на компьютере пользователя.
7. С помощью вредоносных программ злоумышленник может повторно украсть имя пользователя и пароль, а также другие учетные данные с локального компьютера и выполнять другие вредоносные действия.

Средства использования форм
1. Злоумышленник получает имя пользователя и пароль одного из пользователей.
2. Затем злоумышленник Войдите в почтовый ящик Exchange пользователя. Почтовый ящик может находиться в Exchange Online или в локальной среде Exchange.
3. Затем злоумышленник создает настраиваемый шаблон формы почты и вставляет его в почтовый ящик пользователя.  Настраиваемая форма запускается, когда почтовый ящик получает сообщение электронной почты, которое требует от почтового ящика загрузки настраиваемой формы. Настраиваемая форма и формат электронной почты настроены для друг друга.
4. Злоумышленник отправляет пользователю триггер электронной почты, который использует свой почтовый ящик обычным образом.
5. При получении сообщения электронной почты загружается форма. Форма запускает приложение на удаленном сервере (WebDAV).
6. Приложение обычно устанавливает вредоносные программы, такие как [PowerShell емпире](https://www.powershellempire.com/), на компьютере пользователя.
7. С помощью вредоносных программ злоумышленник может повторно украсть имя пользователя и пароль, а также другие учетные данные с локального компьютера и выполнять другие вредоносные действия.


## <a name="what-a-rules-and-custom-forms-injection-attack-might-look-like-office-365"></a>Как могут выглядеть правила и возможность внедрения пользовательских форм, например Office 365?

Эти механизмы сохранения вряд ли будут замечены пользователями, и в некоторых случаях они даже могут быть невидимы.  В этой статье рассказывается, как найти любой из семи знаков (индикаторов компромиссов), перечисленных ниже. Если вы нашли какое-либо из этих данных, выполните действия по устранению неполадок.

- Признаки компромисса правил
    - Действие правила заключается в запуске приложения.
    - Правило ссылается на файл EXE, ZIP или URL-адрес.
    - На локальном компьютере найдите новый процесс, который начинается с PID Outlook.
- Индикаторы раскрытие настраиваемых форм 
    - Настраиваемая форма сохранена в качестве собственного класса сообщений.
    - Класс Message содержит исполняемый код.
    - Обычно хранится в библиотеке личных форм или папках "Входящие".
    - Форма называется IPM. Ноте. [имя пользователя].

## <a name="steps-for-finding-signs-of-this-attack-and-confirming-it"></a>Действия, которые следует выполнить, чтобы найти признаки этой атаки и подтвердить ее
Для подтверждения атаки можно использовать любой из этих двух способов.
- Вручную Проанализируйте правила и формы для каждого почтового ящика с помощью клиента Outlook.  Этот метод является исчерпывающим, но вы можете только проверить пользователя почтового ящика, что может занять много времени, если у вас много пользователей для проверки.  Кроме того, это может привести к нарушению работы компьютера, на котором выполняется проверка.
- Используйте сценарий PowerShell [жет-аллтенантрулесандформс. ps1](https://github.com/OfficeDev/O365-InvestigationTooling/blob/master/Get-AllTenantRulesAndForms.ps1) для автоматического дампа всех правил переадресации почты и настраиваемых форм для всех пользователей в вашем клиенте. Это самый быстрый и безопасный метод с минимальным количеством издержек.


### <a name="confirm-the-rules-attack-using-the-outlook-client"></a>Подтверждение атаки на правила с помощью клиента Outlook
1. Откройте клиент Outlook "Пользователи" в качестве пользователя.  Пользователю может потребоваться помощь в анализе правил почтового ящика.
2. Сведения об [управлении сообщениями электронной почты](https://support.office.com/article/manage-email-messages-by-using-rules-c24f5dea-9465-4df4-ad17-a50704d66c59#ID0EAABAAA=2010) можно найти в статье Rules for the Rules for a The Rules in a 2007, 2010 или 2013 версии Outlook.
3. Найдите правила, которые пользователь не создал, или некоторые непредусмотренные правила или правила с подозрительными именами.
4. Просмотрите описание правила для действий правил, которые запускаются и заменяют или ссылаются на. EXE,. ZIP-файл или для запуска URL-адреса.
5. Ищите все новые процессы, которые начинаются с идентификатора процесса Outlook.  Обратитесь к разделу [Find ID процесса](https://docs.microsoft.com/windows-hardware/drivers/debugger/finding-the-process-id).

### <a name="steps-to-confirm-the-forms-attack-using-the-outlook-client"></a>Действия по подтверждению атак на формы с помощью клиента Outlook
1. Откройте клиент Outlook для пользователя.
2. Выполните действия, описанные в разделе ["Отображение вкладки" Разработчик "](https://support.office.com/article/show-the-developer-tab-e1192344-5e56-4d45-931b-e5fd9bea2d45) для версии Outlook" Пользователи ".
3. Откройте вкладку Разработчик видимой формы в Outlook и щелкните **создать форму**.
4. Выберите **папку "Входящие"** в списке **Искать в** . Поиск настраиваемых форм.  Настраиваемые формы достаточно редки, если у вас есть настраиваемые формы, что стоит более глубокое представление.
5. Изучите все настраиваемые формы, особенно помеченные как скрытые.
6. Откройте все настраиваемые формы и в группе **форма** щелкните **Просмотр кода** , чтобы увидеть, что происходит при загрузке формы.

### <a name="steps-to-confirm-the-rules-and-forms-attack-using-powershell"></a>Действия по подтверждению атак на правила и формы с помощью PowerShell
Самый простой способ проверить правила или атаку пользовательских форм — запустить сценарий PowerShell [жет-аллтенантрулесандформс. ps1](https://github.com/OfficeDev/O365-InvestigationTooling/blob/master/Get-AllTenantRulesAndForms.ps1) .  Этот сценарий подключается к каждому почтовому ящику в клиенте и копирует все правила и формы в два CSV-файла.

#### <a name="pre-requisites"></a>Предварительные требования
Для запуска скрипта вам потребуется иметь права глобального администратора, так как сценарий подключается к каждому почтовому ящику в клиенте для чтения правил и форм.

1. Войдите на компьютер, на котором будет выполняться сценарий с правами локального администратора.
2. Скачайте или скопируйте сценарий жет-аллтенантрулесандформс. ps1 из GitHub в папку, из которой она будет запускаться.  Сценарий создаст два файла с метками даты в этой папке, Маилбоксформсекспорт-ИИИИ-мм-дд. csv и Маилбоксрулесекспорт-ИИИИ-мм-дд. csv.
3. Откройте экземпляр PowerShell от имени администратора и откройте папку, в которой сохранен сценарий.
4. Выполните следующую команду PowerShell, выполнив `.\Get-AllTenantRulesAndForms.ps1`указанные ниже .\Get-AllTenantRulesAndForms.ps1

#### <a name="interpreting-the-output"></a>Интерпретация выходных данных

Маилбоксрулесекспорт-*гггг-мм-дд*. csv — изучите правила (по одному для каждой строки) для условий действий, включающих приложения или исполняемые файлы.
- Тип объекта (столбец A) — Если отображается значение "ИД_АКТИОН_КУСТОМ", то правило, скорее всего, является вредоносным.
- ИспотентиаллималиЦиаус (столбец D) — если это значение "TRUE", правило, скорее всего, является вредоносным.
- Актионкомманд (столбец G) — при наличии в списке приложения или любого файла с расширением exe, ZIP или записью, ссылающейся на URL-адрес, это правило, скорее всего, является вредоносным.

Маилбоксформсекспорт-*гггг-мм-дд*. csv — в общем случае использование настраиваемых форм очень редко.  Если вы найдете в этой книге, вы открываете его почтовый ящик и изучаете форму.  Если ваша организация не предоставила ее намеренно, вероятно, она является вредоносной.



## <a name="how-to-stop-and-remediate-the-outlook-rules-and-forms-attack"></a>Как остановить и исправить атаку для правил и форм Outlook
Если вы обнаружите какое-либо свидетельство этих атак, это просто удалите правило или форму из почтового ящика. Для удаления правил можно использовать клиент Outlook или удаленная оболочка PowerShell.

### <a name="using-outlook"></a>Использование Outlook
1. Определите все устройства, используемые пользователем в Outlook.  Все они должны быть очищены от потенциальных вредоносных программ.  Не разрешать пользователю выполнять вход и использовать электронную почту, пока все устройства не будут очищены.
2. Выполните действия, описанные в разделе [Удаление правила](https://support.office.com/article/Delete-a-rule-2F0E7139-F696-4422-8498-44846DB9067F) для каждого устройства.
3. Если вы не знаете о присутствии других вредоносных программ, вы можете отформатировать и повторно установить все программное обеспечение на устройстве.  Для мобильных устройств вы можете выполнить действия производителя, чтобы вернуть устройство к заводским изображениям.
4. Установите последние версии Outlook.  Помните, что текущая версия Outlook блокирует оба типа этой атаки по умолчанию.
5. После удаления всех автономных копий почтового ящика выполните сброс пароля пользователя (используйте высококачественную проверку подлинности) и выполните действия, описанные в статье [Настройка многофакторной проверки подлинности для пользователей Office 365](https://support.office.com/article/Set-up-multi-factor-authentication-for-Office-365-users-8f0454b2-f51a-4d9c-bcde-2c48e41621c6) , если MFA еще не включен. Это гарантирует, что учетные данные пользователя не будут видны с помощью других средств (таких как фишинг или повторное использование пароля).

### <a name="using-powershell"></a>Использование PowerShell
Существует два удаленных командлетов PowerShell, которые можно использовать для удаления или отключения опасных правил. Следуйте инструкциям.
 
Действия для почтовых ящиков на сервере Exchange Server

1. Подключитесь к серверу Exchange Server с помощью удаленной оболочки PowerShell. Выполните действия, описанные в разделе [Подключение к серверам Exchange с помощью удаленной оболочки PowerShell](https://docs.microsoft.com/powershell/exchange/exchange-server/connect-to-exchange-servers-using-remote-powershell?view=exchange-ps).
2. Если вы хотите полностью удалить одно правило, несколько правил или все правила из почтового ящика, используйте [командлет Remove – Inbox ](https://docs.microsoft.com/powershell/module/exchange/mailboxes/Remove-InboxRule?view=exchange-ps), чтобы полностью удалить одно или несколько правил из почтового ящика.
3. Если вы хотите сохранить правило и его содержимое для дальнейшего изучения, используйте [командлет Disable – InboxRule](https://technet.microsoft.com/en-us/library/dd298120(v=exchg.160).aspx). 

Действия для почтовых ящиков в Exchange Online
1. Выполните действия, описанные в статье [Подключение к Exchange Online с помощью PowerShell](https://docs.microsoft.com/powershell/exchange/exchange-online/connect-to-exchange-online-powershell/connect-to-exchange-online-powershell?view=exchange-ps).
2.  Если вы хотите полностью удалить одно правило, несколько правил или все правила из почтового ящика, используйте [командлет Remove – Inbox Rule](https://docs.microsoft.com/powershell/module/exchange/mailboxes/Remove-InboxRule?view=exchange-ps).
3.  Если вы хотите сохранить правило и его содержимое для дальнейшего изучения, используйте [командлет Disable – InboxRule](https://technet.microsoft.com/en-us/library/dd298120(v=exchg.160).aspx). 

## <a name="how-to-minimize-future-attacks"></a>Как свести к минимуму атаки на будущее

### <a name="first-protect-your-accounts"></a>Первая: Защитите свои учетные записи

Использование правил и форм используется только злоумышленником после кражи или нарушения одной из учетных записей пользователя. Таким образом, первый шаг к предотвращению использования этих эксплойтов в Организации состоит в агрессивной защите учетных записей пользователей.  Некоторые из наиболее распространенных способов нарушения безопасности учетных записей — фишинговые атаки или [пароли](http://www.dabcc.com/microsoft-defending-against-password-spray-attacks/) .



Лучший способ защиты учетных записей пользователей и, особенно учетных записей администраторов, — [Настройка многофакторной проверки подлинности для пользователей Office 365](https://support.office.com/article/set-up-multi-factor-authentication-for-office-365-users-8f0454b2-f51a-4d9c-bcde-2c48e41621c6).  Кроме того, следует:
<ol>
    <li>Отслеживайте <a href="https://docs.microsoft.com/azure/active-directory/active-directory-view-access-usage-reports">доступ и использование</a>учетных записей пользователей. Вы не можете помешать исходному нарушению, но вы Сократите длительность и последствия нарушения, выполнив обнаружение. Вы можете использовать их: <a href="https://docs.microsoft.com/cloud-app-security/what-is-cloud-app-security">Office 365 Cloud App Security Policies</a> для мониторинга учетных записей и оповещения о необычных действиях. 
        <ol type="a">
            <li><b>Несколько неудачных попыток входа</b> Эта политика выполняет профили вашей среды и запускает оповещения, когда пользователи выполняют несколько неудачных операций входа в один сеанс с учетом общедоступного базового плана, что может означать неудачное нарушение.</li>
            <li><b>Неосуществимое путешествие</b> - Эта политика используется для профилей среды и запускает оповещения при обнаружении действий от одного и того же пользователя в различных расположениях в течение периода времени, который меньше, чем ожидаемое время поездки между двумя местоположениями. Это может указывать на то, что другой пользователь использует одни и те же учетные данные. Чтобы определить это необычное поведение, вам следует начальный период обучения в семь дней, в течение которого он узнает о новом шаблоне действий пользователя.</li>
            <li><b>Необычные действия олицетворения (по пользователям)</b> - Эта политика выполняет профили вашей среды и запускает оповещения, когда пользователи выполняют несколько олицетворенных действий в рамках одного сеанса с учетом базовых изученных значений, что может означать нарушение попытки.</li>
        </ol>
    </li>
    <li>Используйте средство, аналогичное <a href="https://securescore.office.com/">показателю безопасности Office 365</a> , для управления конфигурацией и поведением безопасности учетных записей. 
    </li>
</ol> 

### <a name="second-keep-your-outlook-clients-current"></a>Second: Оставайтесь в курсе текущих клиентов Outlook
В полностью обновленных и исправленных версиях Outlook 2013 и 2016 отключить действие правила и формы "Запуск приложения" по умолчанию.  Это гарантирует, что даже если злоумышленник нарушает учетную запись, действия в отношении правил и форм будут блокироваться.  Вы можете установить последние обновления и обновления для системы безопасности, выполнив действия, описанные в [статье Install Office Updates](https://support.office.com/article/Install-Office-updates-2ab296f3-7f03-43a2-8e50-46de917611c5).

Ниже приведены версии исправлений для клиентов Outlook 2013 и 2016:
- Outlook 2013:15.0.4937.1000 или более поздней версии
- Outlook 2016:16.0.4534.1001 или более поздней версии

Дополнительные сведения об индивидуальных обновлениях для системы безопасности можно найти в следующих статьях:

- [Исправление для системы безопасности Outlook 2013](https://support.microsoft.com/en-us/help/3191938) 
- [Исправление для системы безопасности Outlook 2016](https://support.microsoft.com/en-us/help/3191883)

### <a name="third-monitor-your-outlook-clients"></a>Третья: мониторинг клиентов Outlook
Обратите внимание, что даже с установленными исправлениями и обновлениями злоумышленник может изменить конфигурацию локального компьютера, чтобы снова включить поведение "запустить приложение". С помощью [расширенного управления групповыми политиками](https://docs.microsoft.com/microsoft-desktop-optimization-pack/agpm/) можно отслеживать и применять политики локального компьютера для клиентов.  
С помощью сведений, приведенных в статье [Просмотр системного реестра с помощью 64 разрядных версий Windows](https://support.microsoft.com/en-us/help/305097/how-to-view-the-system-registry-by-using-64-bit-versions-of-windows), можно проверить, включено ли повторное включение приложения с помощью переопределения в реестре.  Проверьте следующие подразделы: 

- Outlook 2016: HKEY_CURRENT_USER\Software\Microsoft\Office\16.0\Outlook\Security\
- Outlook 2013: HKEY_CURRENT_USER\Software\Microsoft\Office\15.0\Outlook\Security\

Найдите раздел Енаблеунсафеклиентмаилрулес. Если он есть и имеет значение 1, то исправление для системы безопасности Outlook было переопределено, а компьютер подвержен атакам форм и правил. Если значение равно 0, действие "Запуск приложения" отключено.  Если на компьютере установлена обновленная и исправленная версия Outlook и этот раздел реестра отсутствует, система не подвержена этим атакам.

Для пользователей с локальными установками Exchange необходимо заблокировать старые версии Outlook, в которых нет доступных исправлений. Подробные сведения об этом процессе можно найти в статье [Настройка блокирования клиентов Outlook](https://technet.microsoft.com/en-us/library/dd335207(v=exchg.150).aspx).

## <a name="secure-office-365-like-a-cybersecurity-pro"></a>Защитите Office 365, как профессионал кибербезопасности
Ваша подписка на Office 365 сопровождается целым рядом полезных функций безопасности, которые можно использовать для защиты ваших данных и пользователей.  Обратитесь к статье [Схема для обеспечения безопасности в Office 365: приоритеты на первые 30 и 90 дней, а также на большее количество дней.](https://support.office.com/article/Office-365-security-roadmap-Top-priorities-for-the-first-30-days-90-days-and-beyond-28c86a1c-e4dd-4aad-a2a6-c768a21cb352) и примените описанные в ней рекомендуемые корпорацией Майкрософт приемы по защите вашего клиента Office 365.
- Задачи для выполнения в первые 30 дней.  Они дают немедленный эффект и не создают помех вашим пользователям.
- Задачи для выполнения в течение 90 дней. Эти задачи требуют немного больше времени на планирование и реализацию, но значительно укрепляют вашу безопасность.
- Более 90 дней. Эти меры дополняют ваши действия в течение первых 90 дней.

## <a name="see-also"></a>См. также:
- [Вредоносные правила Outlook](https://silentbreaksecurity.com/malicious-outlook-rules/) с помощью Силентбреак Security POST by Rules предоставляет детальный обзор правил Outlook. 
- Протокол [MAPI over HTTP и Маилруле пвнаже](https://sensepost.com/blog/2016/mapi-over-http-and-mailrule-pwnage/) в блоге Сенсепост о маилруле пвнаже рассказывает об инструменте под названием "линейка", который позволяет использовать почтовые ящики с помощью правил Outlook.
- [Формы и оболочки Outlook](https://sensepost.com/blog/2017/outlook-forms-and-shells/) в блоге Сенсепост о векторе угроз для форм. 
- [Кодовая линейка](https://github.com/sensepost/ruler)
- [Индикаторы раскрытие на линейках](https://github.com/sensepost/notruler/blob/master/iocs.md)