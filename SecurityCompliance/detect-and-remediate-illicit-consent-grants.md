---
title: Обнаружение случаев незаконного предоставления разрешений и устранение их последствий в Office 365
ms.author: chrfox
author: chrfox
manager: laurawi
ms.date: 4/23/2018
ms.audience: ITPro
ms.topic: article
ms.collection:
- o365_security_incident_response
- M365-security-compliance
ms.service: O365-seccomp
localization_priority: Normal
search.appverid:
- MET150
description: Сведения о том, как распознать и исправить незаконное согласие на атаку в Office 365.
ms.openlocfilehash: 454b1b0dcf7a6182895dcc97889286f3000c9626
ms.sourcegitcommit: 8657e003ab1ff49113f222d1ee8400eff174cb54
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/16/2019
ms.locfileid: "30656075"
---
# <a name="detect-and-remediate-illicit-consent-grants-in-office-365"></a>Обнаружение случаев незаконного предоставления разрешений и устранение их последствий в Office 365

**Сводка**  Сведения о том, как распознать и исправить незаконное согласие на атаку в Office 365.

## <a name="what-is-the-illicit-consent-grant-attack-in-office-365"></a>Что такое незаконная атака на предоставление согласия в Office 365?
При атаке с незаконным предоставлением согласия злоумышленник создает приложение, зарегистрированное в Azure, которое запрашивает доступ к данным, например контактной информации, электронной почте или документам. Затем злоумышленник выдает конечному пользователю разрешение на доступ к данным приложения через фишинг или путем добавления нелегального кода в доверенный веб-сайт. После получения согласия у нелегального приложения ему предоставляется доступ к данным на уровне учетной записи без необходимости в Организации. Обычные действия по исправлению, такие как сброс паролей для нарушений учетных записей или требование многоФакторной проверки поДлинности (MFA) для учетных записей, не являются эффективными при атаках этого типа, так как они являются сторонними приложениями и являются внешними по отношению к Организации. Эти атаки используют модель взаимодействия, которая предполагает, что объект, вызывающий эту информацию, является автоматизацией, а не человеком.

## <a name="what-does-an-illicit-consent-grant-attack-look-like-in-office-365"></a>Как выглядит незаконная атака на предоставление согласия в Office 365?
Для поиска знаков, также называемых индикаторами уязвимости (IOC), необходимо выполнить поиск в **журнале аудита** Office 365. Для организаций с множеством приложений, зарегистрированных с помощью Azure, и большим числом пользователей рекомендуется проанализировать предоставление разрешений в организациях еженедельно.
### <a name="steps-for-finding-signs-of-this-attack"></a>Действия по поиску подписывания этой атаки
1. Откройте **Центр безопасности и соответствия требованиям** в клиенте Office 365.
2. Перейдите к узлу **Поиск _амп_ расследования** и выберите пункт Поиск в **журнале аудита** .
3. Создайте Поиск (все действия и все пользователи) и отфильтруйте результаты для получения согласия для приложения и добавьте OAuth2PermissionGrant.
4. Проверьте расширенные свойства и убедитесь, что для Исадминконтент задано значение true.


Если это значение равно true, это указывает на то, что кто с глобальным администратором может получить доступ к данным. Если это не предусмотрено, выполните действия для [подтверждения атаки](detect-and-remediate-illicit-consent-grants.md#confirmattack).

<a name="confirmattack"> </a>
## <a name="how-to-confirm-an-attack"></a>Как проверить атаку
Если у вас есть один или несколько экземпляров Иокс, указанных выше, необходимо провести дальнейшее исследование, чтобы подтвердить возникновение атаки. Для подтверждения атаки можно использовать любой из этих трех способов.
- Приложения инвентаризации и их разрешения с помощью портала Azure Active Directory. Этот метод является исчерпывающим, но вы можете проверять только одного пользователя за раз, что может занять много времени, если у вас много пользователей для проверки.
- Приложения инвентаризации и их разрешения с помощью PowerShell. Это самый быстрый и наиболее тщательный метод, с минимальным количеством издержек.
- ПоПросите пользователей проверить свои приложения и разрешения и отправить результаты обратно администраторам для исправления.

## <a name="inventory-apps-with-access-in-your-organization"></a>Инвентаризация приложений с доступом в Организации
Это можно сделать для пользователей с помощью портала Azure Active Directory или с помощью PowerShell или попросите пользователей отдельно перечислить доступ к приложениям.

### <a name="steps-for-using-the-azure-active-directory-portal"></a>Действия по использованию портала Azure Active Directory
Вы можете найти приложения, которым любой отдельный пользователь предоставил разрешения с помощью [портала Azure Active Directory](https://portal.azure.com/). 
1. Войдите на портал Azure с правами администратора.
2. Выберите колонку Azure Active Directory.
3. Выберите пункт **Пользователи**.
4. Выберите пользователя, которого вы хотите просмотреть.
5. Выберите пункт **приложения**.

Отобразятся приложения, назначенные пользователю, и разрешения, доступные для апплкатионс.

### <a name="steps-for-having-your-users-enumerate-their-application-access"></a>Действия по перечислению доступа пользователей к приложениям
ПоПросите пользователей перейти https://myapps.microsoft.com на свой собственный доступ к приложениям и просмотреть их. Они должны иметь возможность просматривать все приложения с доступом, просматривать подробные сведения о них (в том числе область доступа), а также отменять права на подозрительные или незаконные приложения.

### <a name="steps-for-doing-this-with-powershell"></a>Действия для этого с помощью PowerShell
Самый простой способ убедиться в том, что атака с неЗаконным предоставлением согласия заключается в запуске [жет-азуреадпспермиссионс. ps1](https://gist.github.com/psignoret/41793f8c6211d2df5051d77ca3728c09), в результате чего все разрешения OAuth и приложения OAuth для всех пользователей в вашей организации будут скопированы в один CSV-файл. 

#### <a name="pre-requisites"></a>Предварительные требования
- Библиотека Azure AD PowerShell установлена.
- Права глобального администратора клиента, для которого будет выполняться скрипт.
- Локальный администратор компьютера, на котором будут выполняться сценарии.

> [!IMPORTANT]
> Настоятельно рекомендуется требовать многофакторную проверку подлинности для учетной записи администратора.  Этот скрипт поддерживает проверку подлинности MFA.

1. Войдите на компьютер, на котором будет выполняться сценарий с правами локального администратора.
2. Скачайте или скопируйте сценарий [жет-азуреадпспермиссионс. ps1](https://gist.github.com/psignoret/41793f8c6211d2df5051d77ca3728c09) из GitHub в папку, из которой будет запускаться скруипт.  Это будет та же папка, в которую будет записан выходной файл "Permissions. csv".
3. Откройте экземпляр PowerShell от имени администратора и откройте папку, в которую вы сохранили скрипт.
4. Подключитесь к каталогу с помощью командлета [Connect – AzureAD](https://docs.microsoft.com/powershell/module/azuread/connect-azuread?view=azureadps-2.0) .
5. Выполните следующую команду PowerShell, выполнив указанные ниже действия.`Get-AzureADPSPermissions.ps1 | Export-csv -path "Permissions.csv" -NoTypeInformation`

Сценарий создает один файл с именем Permissions. csv. Выполните следующие действия, чтобы найти незаконные предоставления разрешений приложений: 
1. В столбце Консенттипе (столбец G) найдите значение "АллпринЦиплес". Разрешение АллпринЦипалс позволяет клиентскому приложению получать доступ к контенту всех пользователей в Организации. Встроенные приложения Office 365 требуют, чтобы это разрешение работало правильно. Следует внимательно проанализировать все приложения, отличные от Майкрософт, с этим разрешением.
2.  В столбце Permission (Column F) просмотрите разрешения, которые у каждого делегированного приложения есть в содержимом. Ищите разрешение "чтение" и "запись" или "*. Разрешение ALL и внимательно изучите их, так как они могут быть неуместны.
3.  ИзУчите определенных пользователей, которым предоставлены полученные разрешения. Если высокая или высокая степень влияния на пользователей приводят к неприемлемому получению, следует проанализировать дополнительные сведения.
4.  В столбце Клиентдисплайнаме (столбец C) найдите приложения, которые кажутся подозрительными. Приложения с неправильными именами, именами Super Бланд или звуковыми названиями хакеров следует внимательно рассмотреть.

## <a name="determine-the-scope-of-the-attack"></a>Определение области атаки
Завершив инвентаризацию доступа к приложению, просмотрите **журнал аудита** Office 365, чтобы определить полную область нарушения.  Поиск затронутых пользователей, временных кадров, к которым приложение было незаконно получило доступ к вашей организации, а также разрешения, которые имело приложение. Вы можете выполнить поиск в **журнале аудита** в [центре безопасности и соответствия требованиям Office 365](https://support.office.com/article/Search-the-audit-log-in-the-Office-365-Security-Compliance-Center-0d4d0f35-390b-4518-800e-0c7ec95e946c). 

> [!IMPORTANT]
> [](https://support.office.com/article/Enable-mailbox-auditing-in-Office-365-aaca8987-5b62-458b-9882-c28476a66918) Для получения этих сведений необходимо включить аудит и [Аудит действий для администраторов и пользователей,](https://support.office.com/article/turn-office-365-audit-log-search-on-or-off-e893b19a-660c-41f2-9074-d3631c95a014) прежде чем приступить к атакам.

## <a name="how-to-stop-and-remediate-an-illicit-consent-grant--attack"></a>Как отказаться от атак с незаконным предоставлением согласия
После определения приложения с незаконными разрешениями вы можете удалить этот доступ несколькими способами.
- Вы можете отозвать разрешение приложения на портале Azure Active Directory, выполнив следующие действия:
    - Перейдите к затронутому пользователю в колонке **пользователя Azure Active Directory** .
    - Выберите пункт **приложения**.
    - Выберите нелегальное приложение.
    - Нажмите кнопку **Удалить** в разделе Детализация.
- Вы можете отозвать предоставление согласия OAuth с помощью PowerShell, выполнив действия, описанные в командлете [Remove – AzureADOAuth2PermissionGrant](https://docs.microsoft.com/powershell/module/azuread/Remove-AzureADOAuth2PermissionGrant?view=azureadps-2.0).
- Вы можете отозвать назначение роли приложения службы с помощью PowerShell, выполнив действия, описанные в статье [Remove – азуреадсервицеаппролеассигнмент](https://docs.microsoft.com/powershell/module/azuread/Remove-AzureADServiceAppRoleAssignment?view=azureadps-2.0).
- Вы также можете отключить вход в затронутую учетную запись, что в свою очередь отключит доступ приложений к данным в этой учетной записи. Это не является идеальным условием для продуктивности конечного пользователя, но если вы работаете над ограничениями на снижение влияния, это может быть приемлемым краткосрочным исправлением.
- Вы можете отключить интегрированные приложения для вашего клиента. Это радикальный этап, который отключает возможность предоставления конечным пользователям разрешения на уровне клиента. Это предотвратит непреднамеренное предоставление пользователям доступа к вредоносному приложению. Это не рекомендуется, так как серьезно снижает способность пользователей работать с приложениями сторонних производителей.  Для этого выполните действия, описанные в статье [Включение и отключение интегрированНых приложений](https://support.office.com/article/Turning-Integrated-Apps-on-or-off-7e453a40-66df-44ab-92a1-96786cb7fb34).

## <a name="secure-office-365-like-a-cybersecurity-pro"></a>Безопасность Office 365, например, циберсекурити Pro
Ваша подписка на Office 365 поставляется с мощным набором возможностей обеспечения безопасности, которые можно использовать для защиты данных и пользователей.  Использование [плана безопасности Office 365: лучшие приоритеты для первых 30 дней, 90 дней и](https://support.office.com/article/office-365-security-roadmap-top-priorities-for-the-first-30-days-90-days-and-beyond-28c86a1c-e4dd-4aad-a2a6-c768a21cb352) более поздних для реализации рекомендуемых рекомендаций по обеспечению безопасности клиента Office 365.
- Задачи, которые необходимо выполнить в течение первых 30 дней.  Они немедленно влияют на работу пользователей и оказывают низкую воздействие.
- Задачи, которые необходимо выполнить в течение 90 дней. Для планирования и реализации потребуется немного больше времени, но значительно повысить уровень безопасности.
- Больше 90 дней. Эти расширения задействуются в течение первых 90 дней.

## <a name="see-also"></a>См. также:
- [Неожиданное приложение в списке "Мои приложения](https://docs.microsoft.com/azure/active-directory/application-access-unexpected-application) " просматривает администраторов с помощью различных действий, которые могут потребоваться после реализации приложений с доступом к данным.
- [Интеграция приложений с Azure Active Directory]  (https://docs.microsoft.com/azure/active-directory/active-directory-apps-permissions-consent) это высокоуровневый обзор согласия и разрешений.  Обратите особое внимание на [Обзор раздела инфраструктура согласия](https://docs.microsoft.com/azure/active-directory/develop/active-directory-integrating-applications#overview-of-the-consent-framework) .
- [Проблемы при разработке приложения](https://docs.microsoft.com/azure/active-directory/active-directory-application-dev-development-content-map) предоставляет ссылки на различные статьи, связанные с согласием.
- [Объекты приложения и субъекта-службы в Azure Active Directory (Azure AD)](https://docs.microsoft.com/azure/active-directory/develop/active-directory-application-objects) предоставляет общие сведения об основных объектах приложения и службы, которые являются основными для модели приложения.
- [Управление доступом к приложениям](https://docs.microsoft.com/azure/active-directory/active-directory-managing-access-to-apps) — обзор возможностей, которые администраторы могут использовать для управления доступом пользователей к приложениям.
