---
title: Контроль данных в Office 365 с помощью ключа клиента
ms.author: krowley
author: kccross
manager: laurawi
ms.date: 7/2/2018
ms.audience: ITPro
ms.topic: get-started-article
ms.service: o365-administration
localization_priority: Normal
search.appverid:
- MET150
ms.assetid: f2cd475a-e592-46cf-80a3-1bfb0fa17697
description: Узнайте, как настроить ключ клиента Office 365 для Exchange Online, Скайп для бизнеса, SharePoint Online и OneDrive для бизнеса. С ключом клиента управления ключами шифрования вашей организации и затем настроить Office 365 их использования для шифрования данных статических в центрах обработки данных корпорации Майкрософт.
ms.openlocfilehash: f8d7c12c32ca74b842f676f4a2ccde4d1c758361
ms.sourcegitcommit: 36c5466056cdef6ad2a8d9372f2bc009a30892bb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/27/2018
ms.locfileid: "22559234"
---
# <a name="controlling-your-data-in-office-365-using-customer-key"></a>Контроль данных в Office 365 с помощью ключа клиента

С ключом клиента управления ключами шифрования вашей организации и затем настроить Office 365 их использования для шифрования данных статических в центрах обработки данных корпорации Майкрософт. Статических данных включает в себя данные из Exchange Online и Скайп для бизнеса, которые хранятся в почтовые ящики и файлы, которые хранятся в SharePoint Online и OneDrive для бизнеса.
  
Прежде чем использовать ключ клиента Office 365, необходимо настроить Azure. В этом разделе описаны действия, которые необходимо выполнить для создания и настройки необходимые ресурсы Azure и затем пошаговые инструкции по настройке ключа клиента в Office 365. После завершения установки Azure вам определить, какая политика, а таким образом, какие ключи для назначения почтовые ящики и файлы в вашей организации. Почтовые ящики и файлы, для которых не назначение политики будут использовать политики шифрования, контролируемые и управляемые корпорацией Майкрософт. Дополнительные сведения о ключевых клиента, а также общие сведения просмотрите [Ключа клиента для вопросы и ответы по Office 365](service-encryption-with-customer-key-faq.md).
  
> [!IMPORTANT]
> Мы настоятельно рекомендуем придерживаться рекомендации в этом разделе. Они называются как **ПОДСКАЗКИ** и **важно**. Клиент ключ позволяет корневой ключами шифрования, область действия может быть задано как всей организации. Это означает, что ошибки, сделанных с помощью этих ключей может иметь широкое влияние и может привести к перерыва в обслуживании или безотзывным потери данных. 
  
## <a name="before-you-begin-setting-up-customer-key"></a>Перед началом настройки ключа клиента
<a name="Beforeyoustart"> </a>

Перед началом работы убедитесь, что у вас есть соответствующие лицензирования для вашей организации. Ключ клиента в Office 365, предлагаемых в Office 365 E5 или SKU дополнительные соответствия требованиям.
  
Затем изучить основные понятия и процедуры, описанные в этом разделе, необходимо проверить документации [Помещение ключ Azure](https://azure.microsoft.com/en-us/documentation/services/key-vault/) . Кроме того ознакомиться с терминов, используемых в Azure, например, для [клиента](https://msdn.microsoft.com/library/azure/jj573650.aspx#BKMK_WhatIsAnAzureADTenant).
  
Чтобы оставить отзыв по ключу клиента, включая документацию, отправьте customerkeyfeedback@microsoft.com идеи, предложения и перспективы.
  
## <a name="overview-of-setting-up-customer-key-for-office-365"></a>Общие сведения о настройке ключа клиента Office 365
<a name="Overview"> </a>

Чтобы настроить ключ клиента будет выполнить эти задачи. В этом разделе содержатся подробные инструкции по каждой задачи или ссылки на более подробные сведения для каждого шага процесса в работе.
  
**В Azure и она Майкрософт:**
  
С помощью удаленного подключения к Windows Azure PowerShell завершит большая часть этих задач. Для достижения наилучших результатов используйте версию 4.4.0 или более поздней версии для Windows Azure PowerShell.
  
- [Создание двух новых подписок Azure](controlling-your-data-using-customer-key.md#Create2newsubs)
    
- [Регистрация Azure подписок для использования период обязательные хранения](controlling-your-data-using-customer-key.md#RegisterSubsforMRP)
    
    Регистрация может занять от одного до пяти рабочих дней.
    
- [Отправка запроса для активации ключа клиента Office 365](controlling-your-data-using-customer-key.md#FastTrack)
    
    После создания двух новых подписок Azure, необходимые для отправки соответствующих предложения запроса ключа клиента, выполнив веб-форму, которая размещена на портале Microsoft эту. Группа она не оказание помощи с ключом клиента. Office просто использует эту портала для для отправки формы и для отслеживания соответствующих предложений для ключа клиента.
  
После отправки предложения ключа клиента Microsoft просматривает запрос и уведомляет можно перейти к дальнейшей задачи настройки. Этот процесс может занять до пяти рабочих дней.
    
- [Создание premium помещение ключ Azure в каждой подписки](controlling-your-data-using-customer-key.md#CreateKeyVault)
    
- [Назначение разрешений каждого ключа хранилище](controlling-your-data-using-customer-key.md#KeyVaultPerms)
    
- [Включение и подтвердите обратимым удалением на ключевых хранилищах](controlling-your-data-using-customer-key.md#SoftDelete)
    
- [Добавление ключа для каждого ключа помещение либо путем создания или импорта ключа](controlling-your-data-using-customer-key.md#AddKeystoKeyVault)
    
- [Установите флажок для уровня восстановления ключи](controlling-your-data-using-customer-key.md#CheckKeyRecoveryLevel)
    
- [Помещение резервного копирования Azure ключа](controlling-your-data-using-customer-key.md#BackupAzureKeyVaultkeys)
    
- [Проверка параметров конфигурации помещение ключ Azure](controlling-your-data-using-customer-key.md#Validateconfiguration)
    
- [Получение URI для каждого ключа помещение ключ Azure](controlling-your-data-using-customer-key.md#GetKeyURI)
    
**В Office 365:**
  
Exchange Online и Скайп для бизнеса:
  
- [Создание политики шифрования данных (DEP) для использования с Exchange Online и Скайп для бизнеса](controlling-your-data-using-customer-key.md#CreateDEP4EXOSkype)
    
- [Назначение DEP почтовому ящику](controlling-your-data-using-customer-key.md#assignDEPtomailbox)
    
- [Проверка шифрования почтовых ящиков](controlling-your-data-using-customer-key.md#validatemailboxencryption)
    
SharePoint Online и OneDrive для бизнеса:
  
- [Создание политики шифрования данных (DEP) для каждого SharePoint Online и OneDrive для бизнеса географически](controlling-your-data-using-customer-key.md#CreateDEP4SPOODfB)
    
- [Проверка шифрования группы сайтов, веб-сайтов групп и OneDrive для бизнеса](controlling-your-data-using-customer-key.md#validateencryptionSPO)
    
## <a name="complete-tasks-in-azure-key-vault-and-microsoft-fasttrack-for-customer-key"></a>Выполните задачи в хранилище ключа Azure и она Microsoft для ключа клиента
<a name="AzureSteps"> </a>

Выполните эти задачи в хранилище Azure ключ для настройки ключа клиента для Office 365. Необходимо выполнить следующие действия, независимо от того, является ли планируется настроить ключ клиента для Exchange Online и Скайп для бизнеса или SharePoint Online и OneDrive для бизнеса или для всех поддерживаемых служб в Office 365.
  
### <a name="create-two-new-azure-subscriptions"></a>Создание двух новых подписок Azure
<a name="Create2newsubs"> </a>

Для ключа клиента требуются две Azure подписки. Рекомендуется Корпорация Майкрософт рекомендует создавать новые Azure подписки для использования с ключом клиента. Azure ключи помещение ключ только авторизации для приложений тому же владельцу Azure Active Directory (AAD), необходимо создать новые подписки, с помощью же Azure AD клиента, который используется в организации Office 365, в которой будет назначен DEPs. Например с помощью вашего рабочего или школы учетной записи, имеющей права глобального администратора в организации Office 365. Подробное описание процедуры в разделе [Регистрация для Azure в организации](https://azure.microsoft.com/en-us/documentation/articles/sign-up-organization/).
  
> [!IMPORTANT]
> Ключ клиента требуется два ключи для каждой политики шифрования данных (DEP). Для этого необходимо создать два Azure подписок. Рекомендуется Корпорация Майкрософт рекомендует наличие отдельных членов вашей организации настроить один ключ в каждой подписки. Кроме того эти Azure подписки должен использоваться только для управления ключами шифрования для Office 365. Это обеспечивает защиту вашей организации в случае один из вашего операторов случайно, специально или намеренно удаляет или в противном случае mismanages ключи, для которых они отвечают.<br/> Рекомендуется настроить новые Azure подписки, используемые исключительно для управления ресурсами хранилища Azure ключ для использования с ключом клиента. Нет практические ограничения на число Azure подписок, которые можно создать для вашей организации. Рекомендации будет свести к минимуму влияние человеческого ошибка при помощь в управлении ресурсы, используемые ключа клиента. 
  
### <a name="submit-a-request-to-activate-customer-key-for-office-365"></a>Отправка запроса для активации ключа клиента Office 365
<a name="FastTrack"> </a>

После выполнения действия Azure, вам потребуются для отправки запроса предложения в [портал Microsoft эту](https://fasttrack.microsoft.com/). После отправки запроса через эту веб-портала Microsoft проверяет Azure ключ хранилище данных и контакт сведения о конфигурации, указанного. Выбором, сделанным в форме предложение о авторизованного ответственные за вашей организации является важным и необходимые для завершения регистрации ключа клиента. Ответственные за вашей организации, выбранного в форме будет использоваться для обеспечения подлинности все запросы для отмены и удалить все клавиши, которые используются с политикой шифрования данных ключа клиента. Вам потребуется сделать это действие один раз, чтобы активировать ключ клиента для Exchange Online и Скайп для бизнеса покрытия и еще раз активировать ключ клиента для SharePoint Online и OneDrive для бизнеса.
  
Чтобы отправить предложение для активации ключа клиента, выполните следующие действия:
  
1. Использование рабочего или школы учетной записи, имеющей права глобального администратора в организации Office 365, выполните вход в [портал Microsoft эту](https://fasttrack.microsoft.com/).
    
2. После входа в, перейдите к **панели мониторинга**.
    
3. Выберите **предлагает**и просмотрите список текущего предложения.
    
4. Выберите **Дополнительные** предложения, которое применяется к вам: 
    
  - **Exchange Online и Скайп для бизнеса:** Выберите команду **Дополнительные** предложение **Ключа клиента для Exchange** . 
    
  - **SharePoint Online и OneDrive для бизнеса:** Выберите **Дополнительные** на предложение **Ключа клиента для SharePoint и OneDrive для бизнеса** . 
    
5. На странице **получения подробных сведений** выберите **Создать запрос**.
    
6. Заполните все сведения, которые применяются и запрошенные данные в форме предложение. Обратите особое внимание выбранных элементов для каких ответственные за вашей организации будет использоваться для авторизации для утверждения уничтожения постоянные и нельзя обратить ключами шифрования и данных. После выполнения формы, нажмите кнопку **Submit**.
    
    Этот процесс может занять до пяти рабочих дней после Microsoft получила уведомление запроса.
    
7. Перейдите на обязательные хранения периода ниже раздел.
    
### <a name="register-azure-subscriptions-to-use-a-mandatory-retention-period"></a>Регистрация Azure подписок для использования период обязательные хранения
<a name="RegisterSubsforMRP"> </a>

Временное или постоянное потеря ключами шифрования корневой может быть очень аварийные или даже аварийное операции службы и может привести к потере данных. По этой причине ресурсы, используемые с ключом клиента требуется усиленная защита. Все Azure ресурсы, которые используются с ключом клиента предлагают механизмов защиты за пределы конфигурация по умолчанию. Azure подписок можно с меткой или зарегистрирована, чтобы не позволит немедленные и безотзывным отмены. Это называется регистрации в течение обязательные хранения. Действия, необходимые для регистрации Azure подписок в течение обязательные хранения требуется совместной работы с Office 365 team. Этот процесс может занять от одного до пяти рабочих дней. Ранее это было иногда называется «Не отменить».
  
Перед обращением группы Office 365, необходимо выполнить следующие действия для каждой подписки Azure, используемая с ключом клиента:
  
1. Выполните вход Azure подписки с помощью Azure PowerShell. Инструкции [Войдите в систему с Azure PowerShell](https://docs.microsoft.com/powershell/azure/authenticate-azureps?view=azurermps-4.3.1)см.
    
2. Выполните командлет Register-AzureRmProviderFeature для регистрации подписок на использование обязательных срок.
    
  ```
  Register-AzureRmProviderFeature -FeatureName mandatoryRetentionPeriodEnabled -ProviderNamespace Microsoft.Resources
  ```

3. Обратитесь в Майкрософт, чтобы завершить процесс. Для SharePoint и OneDrive для бизнеса группы контактов [spock@microsoft.com](mailto:spock@microsoft.com). Для Exchange Online и Скайп для бизнеса обратитесь в [exock@microsoft.com](mailto:exock@microsoft.com). Соглашение об уровне службы (SLA) для завершения этой процедуры, пяти рабочих дней после Microsoft был получают уведомление в случае (и проверить), который вы зарегистрировали подписок на использование обязательных срок. В электронную почту, относятся следующие:
    
    **Тема**: ключа клиента для \< *полное доменное имя вашего клиента*\> 
    
    **Body**: идентификаторы подписки, для которых требуется предоставить обязательные хранения период завершен. 
    
4. Как только вы получите уведомление от Майкрософт о завершении регистрации, проверьте состояние регистрацию с помощью командлета Get-AzureRmProviderFeature следующим образом:
    
  ```
  Get-AzureRmProviderFeature -ProviderNamespace Microsoft.Resources -FeatureName mandatoryRetentionPeriodEnabled
  ```

5. Убедившись, что свойство **Состояние регистрации** из командлета Get-AzureRmProviderFeature возвращает значение **зарегистрирован**, выполните следующую команду, чтобы завершить процесс:
    
  ```
  Register-AzureRmResourceProvider -ProviderNamespace "Microsoft.KeyVault"
  ```

### <a name="create-a-premium-azure-key-vault-in-each-subscription"></a>Создание premium помещение ключ Azure в каждой подписки
<a name="CreateKeyVault"> </a>

Порядок создания ключа помещение описаны в [Начало работы с Azure ключ помещение](https://azure.microsoft.com/documentation/articles/key-vault-get-started/), содержащий инструкции по установки и запуска Azure PowerShell, подключение к своей подписке Azure, создания группы ресурсов и создание ключа хранилище, в которой Группа ресурсов.
  
При создании ключа хранилище, необходимо выбрать SKU: стандартный или расширенный. Стандартный SKU позволяет ключи хранилище Azure ключ защищен с помощью программ - нет ключа защиты аппаратного модуля безопасности (HSM) - и Premium SKU позволяет использовать HSM для защиты ключей помещение ключ. Ключ клиента принимает ключевые хранилищах, использующие либо SKU Хотя корпорация Майкрософт рекомендует использовать только SKU Premium. Стоимость операций с ключами любого из этих типов не изменяется, поэтому только разница в себестоимости расходы в месяц для каждого защищенного HSM ключа. Для получения дополнительных сведений в разделе [Цена помещение ключ](https://azure.microsoft.com/pricing/details/key-vault/) . 
  
> [!IMPORTANT]
> Используйте хранилищах ключевые Premium SKU и защищенные HSM ключи для производственных данных, а только с помощью клавиш и стандартных SKU ключевые хранилищах для целей тестирования и проверки. 
  
Для каждой службы Office 365, с которым будет использовать ключ клиента Создание ключа помещение в каждой из двух Azure подписки, которые вы создали. Например для Exchange Online, а Скайп для работы только или SharePoint Online и OneDrive для бизнеса только, создается только одна пара хранилищах. Чтобы включить ключа клиента для Exchange Online и SharePoint Online, создается две пары ключей хранилищах.
  
Используйте схему именования для ключа хранилищах, отражает целям использования DEP, с которым будет связана хранилищах. В разделе Рекомендации по ниже naming convention рекомендации.
  
Создайте отдельный, парного набор хранилищах для каждой политики шифрования данных. Для Exchange Online область политика шифрования данных выбранные вами при назначении политики почтовых ящиков. Почтовый ящик может иметь только одну политику, назначенную и можно создать до 50 политики. Для SharePoint Online область политики — все данные из организации в месте или географически.
  
Создание ключа хранилищах также требует создания группы Azure ресурсов, поскольку ключевые хранилищах необходимы емкость хранилища (хотя очень маленькие) и помещение ключ ведение журнала, если этот параметр включен, также создает хранимых данных. Рекомендуется Корпорация Майкрософт рекомендует использовать отдельный администраторам управлять каждой группе ресурсов с помощью администрирования по краю с набором администраторов, которые будет управлять всех связанных с ними ресурсы ключа клиента.
  
> [!IMPORTANT]
> Для обеспечения максимальной доступности, ключевые хранилищах должен находиться в области ближе к службе Office 365. К примеру Если организации Exchange Online в Северной Америке, поместите ключевые хранилищах в Северной Америке. Если организации Exchange Online в Европе, поместите ключевые хранилищах в Европе.<br/>Использовать общий префикс для ключа хранилищах и включают сокращение использования и область применения ключа хранилище и разделов (например, для службы Contoso SharePoint, расположение хранилищах в Северной Америке, пара возможных имен Contoso-O365SP-NA-VaultA1 и Contoso-O365SP-NA-VaultA2. Помещение имена являются глобальный уникальный строками в Azure, поэтому может потребоваться попробуйте вариантов желаемую имен в случае, если требуемый имена уже заявленным другой Azure клиенты. По состоянию на июля 2017 помещение имена нельзя изменить, поэтому рекомендуется составить план написанного для программы установки и использование второго пользователя для проверки, что план выполняется правильно.<br/>Если это возможно создайте вашей хранилищах не пару регионов. Парного Azure областей обеспечения высокой доступности в доменах сбоя службы. Таким образом региональных пары может рассматриваться как резервного копирования область друг друга. Это означает, что Azure ресурс, который переводится в одной области, автоматически увеличит отказоустойчивость через парного область. По этой причине выбор областей для двух хранилищах, используемые в DEP, где области, парного означает, что используются только всего двух областей доступности. Большинство географических расположениях только имеют двух областей, поэтому он еще не можно выбрать, не сопоставленных областей. Если это возможно выберите двух областей не пару для двух хранилищах используется с предотвращения выполнения данных. Это преимущества всего четыре области доступности. Дополнительные сведения можно [Business continuity и аварийное восстановление (BCDR): областей в сочетании Azure](https://docs.microsoft.com/azure/best-practices-availability-paired-regions) для текущего списка региональных пар. 
  
### <a name="assign-permissions-to-each-key-vault"></a>Назначение разрешений каждого ключа хранилище
<a name="KeyVaultPerms"> </a>

Для каждого ключа хранилище необходимо определить три отдельных наборов разрешений для ключа клиента, в зависимости от реализации. Например необходимо определить один набор разрешений для каждой из следующих:
  
- **Администраторы хранилище ключа** , которое будет выполнять повседневного управления ключевые хранилище для вашей организации. Эти задачи включают резервного копирования, создание, получение, также импортировать, список и восстановления. 
    
    > [!IMPORTANT]
    > Набор разрешений, назначенных ключевых помещение администраторы не включает разрешение на удаление ключей. Это не является ошибкой и важные рекомендации. Удаление ключей шифрования не происходит обычно, так как это так без возможности восстановления приведет к потере данных. Рекомендуется не предоставить такое разрешение администраторам ключевые хранилище по умолчанию. Вместо этого зарезервировать это для ключа помещение участники только его и назначьте администратора на основе краткосрочной перспективе после поняты понять последствия. 
  
    Чтобы назначить эти разрешения для пользователей в организации Office 365, выполните вход в Azure подписки с помощью Azure PowerShell. Инструкции [Войдите в систему с Azure PowerShell](https://docs.microsoft.com/powershell/azure/authenticate-azureps?view=azurermps-4.3.1)см.
    
- Запустите командлет Set-AzureRmKeyVaultAccessPolicy, чтобы предоставить необходимые разрешения.
    
  ```
  Set-AzureRmKeyVaultAccessPolicy -VaultName <vaultname> 
  -UserPrincipalName <UPN of user> -PermissionsToKeys create,import,list,get,backup,restore
  ```

  Пример:
    
  ```
  Set-AzureRmKeyVaultAccessPolicy -VaultName Contoso-O365EX-NA-VaultA1 
  -UserPrincipalName alice@contoso.com -PermissionsToKeys create,import,list,get,backup,restore
  ```

- **Участники помещение ключ** , который можно изменить разрешения на помещение ключ Azure самого. Вам потребуется изменить эти разрешения, как сотрудники оставьте или присоединиться к группе или в очень редких случаях, что ключ помещение Администраторы законного необходимы разрешения, чтобы удалить или восстановить ключ. Этот набор ключевых помещение участники необходимо предоставить роли **корреспондента** на ключевых хранилище. Эту роль можно назначить с помощью диспетчера ресурсов Azure. Подробное описание шагов см [Use Role-Based для управления доступом к ресурсам подпиской Azure](https://docs.microsoft.com/azure/active-directory/role-based-access-control-configure). Администратор, который создает подписку имеет доступ неявно, а также возможность назначать другим администраторам роли корреспондента.
    
- Если вы планируете использовать ключ клиента с помощью Exchange Online и Скайп для бизнеса, необходимо предоставить разрешение в Office 365 для использования ключа помещение от имени Exchange Online и Скайп для бизнеса. Аналогичным образом Если вы планируете использовать ключ клиента с помощью SharePoint Online и OneDrive для бизнеса, необходимо добавить разрешение для Office 365 для использования ключа помещение от имени SharePoint Online и OneDrive для бизнеса. Чтобы предоставить разрешение в Office 365, выполните командлет **Set-AzureRmKeyVaultAccessPolicy** , используя следующий синтаксис: 
    
  ```
  Set-AzureRmKeyVaultAccessPolicy -VaultName <vaultname> -PermissionsToKeys wrapKey,unwrapKey,get -ServicePrincipalName <Office 365 appID>
  ```

    Где:
    
  - *vaultname* — это имя ключа vault, которую вы создали. 
    
  - Exchange Online и Скайп для бизнеса замените *appID Office 365* с помощью`00000002-0000-0ff1-ce00-000000000000`
    
  - SharePoint Online и OneDrive для бизнеса замените *appID Office 365* с помощью`00000003-0000-0ff1-ce00-000000000000`
    
  Пример: Задание разрешений для Exchange Online и Скайп для бизнеса:
    
  ```
  Set-AzureRmKeyVaultAccessPolicy -VaultName Contoso-O365EX-NA-VaultA1 
  -PermissionsToKeys wrapKey,unwrapKey,get -ServicePrincipalName 00000002-0000-0ff1-ce00-000000000000
  ```

  Пример: Задание разрешений для SharePoint Online и OneDrive для бизнеса
    
  ```
  Set-AzureRmKeyVaultAccessPolicy -VaultName Contoso-O365SP-NA-VaultA1 
  -PermissionsToKeys wrapKey,unwrapKey,get -ServicePrincipalName 00000003-0000-0ff1-ce00-000000000000
  ```

### <a name="enable-and-then-confirm-soft-delete-on-your-key-vaults"></a>Включение и подтвердите обратимым удалением на ключевых хранилищах
<a name="SoftDelete"> </a>

Когда можно быстро восстановить ключи, вы вероятность продолжаться расширенные службы из-за намеренно или случайно удаленных разделов. Необходимо включить конфигурацию, называется программных удалить, прежде чем использовать ключи с ключом клиента. Включение программных удаление позволяет восстанавливать ключи или хранилищами в течение 90 дней после удаления без необходимости их восстановления из резервной копии.
  
Чтобы включить удаление использования программных на ключевых хранилищах, выполните следующие действия:
  
1. Выполните вход Azure подписки с помощью Windows Powershell. Инструкции [Войдите в систему с Azure PowerShell](https://docs.microsoft.com/powershell/azure/authenticate-azureps)см.
    
2. Выполните командлет [Get-AzureRmKeyVault](https://docs.microsoft.com/powershell/module/azurerm.keyvault/get-azurermkeyvault) . В этом примере *vaultname* — это имя ключа vault, для которого включается обратимым удалением: 
    
   ```
   $v = Get-AzureRmKeyVault -VaultName <vaultname>
   $r = Get-AzureRmResource -ResourceId $v.ResourceId
   $r.Properties | Add-Member -MemberType NoteProperty -Name enableSoftDelete -Value 'True'
   Set-AzureRmResource -ResourceId $r.ResourceId -Properties $r.Properties
   ``` 
    
3. Убедитесь, что настройки обратимым удалением для ключа хранилище с помощью командлета **Get-AzureRmKeyVault** . Если обратимым удалением настроена должным образом ключевые vault, обратимо удалять включено? свойство возвращает значение **True**: 
    
   ```
   Get-AzureRmKeyVault -VaultName <vaultname> | fl
   ```

   
    
### <a name="add-a-key-to-each-key-vault-either-by-creating-or-importing-a-key"></a>Добавление ключа для каждого ключа помещение либо путем создания или импорта ключа
<a name="AddKeystoKeyVault"> </a>

Существует два способа добавления ключей Azure хранилище ключа; можно создать ключ непосредственно в хранилище ключа или импорта ключа. Создание ключа непосредственно в хранилище ключ — это метод проще Импорт ключа обеспечивает полного контроля над созданием ключ.
  
Для создания ключа непосредственно в ключевых vault, выполните командлет [Add-AzureKeyVaultKey](https://docs.microsoft.com/powershell/module/AzureRM.KeyVault/Add-AzureKeyVaultKey) следующим образом: 
  
```
Add-AzureKeyVaultKey -VaultName <vaultname> -Name <keyname> -Destination <HSM|Software> -KeyOps wrapKey,unwrapKey
```

Где:
  
-  *vaultname* — это имя ключа хранилище, в котором вы хотите создать ключ. 
    
-  *keyName* — это имя, которое будет нового ключа. 
    
    > [!TIP]
    > Имя клавиш с помощью следующего соглашение об именовании, как описано выше для ключа хранилищах. Таким образом, в меню Сервис, которые показывают только имя ключа, строка собственное описание. 
  
- Если для защиты ключа с аппаратного, убедитесь, что указать **HSM** в качестве значения параметра _назначения_ , в противном случае **программного обеспечения**.
    
Например:
  
```
Add-AzureKeyVaultKey -VaultName Contoso-O365EX-NA-VaultA1 -Name Contoso-O365EX-NA-VaultA1-Key001 -Destination Software -KeyOps wrapKey,unwrapKey
```

Чтобы импортировать ключ непосредственно в ключевые хранилище, необходимо иметь Thales nShield аппаратного модуля безопасности.
  
Некоторые организации предпочитают этот подход для установления provenance их ключей и этого метода также предоставляет следующее:
  
- Набор инструментов, используемый для импорта включает в себя аттестации из Thales, что ключ Exchange ключ (KEK), который используется для шифрования ключа, создаваемые невозможен и создается внутри подлинность HSM, произведена корпорацией Thales.
    
- Набор инструментов включает в себя аттестации из Thales, что мир хранилище Azure ключ безопасности также был создан на подлинность HSM производства Thales. В этом аттестации подтверждает вам, что Майкрософт также использует подлинность Thales оборудования.
    
Обратитесь к вашей группы безопасности, чтобы определить, требуются ли выше attestations. Подробное описание шагов для создания ключа в локальной и импортировать ключевые помещение Узнайте, [как для создания и перемещения защищенного HSM ключи для ключа хранилище Azure](https://azure.microsoft.com/documentation/articles/key-vault-hsm-protected-keys/). Используйте Azure инструкции для создания ключа в каждой ключевые хранилище.
  
### <a name="check-the-recovery-level-of-your-keys"></a>Установите флажок для уровня восстановления ключи
<a name="CheckKeyRecoveryLevel"> </a>

Office 365 требует подписки на хранилище Azure ключ имеет значение не отменить и иметь обратимым удалением включено клавиш, используемых ключа клиента. В этом можно убедиться, посмотрев уровень восстановления на ключи.
  
Чтобы проверить уровень восстановления ключа в Windows Azure PowerShell, выполните командлет Get-AzureKeyVaultKey следующим образом:
  
```
(Get-AzureKeyVaultKey -VaultName <vaultname> -Name <keyname>).Attributes 
```

Свойство _Уровень восстановления_ возвращает отличное от значения **Устранимая + ProtectedSubscription**, необходимо изучить раздел и убедитесь, что выполнены все действия, чтобы поместить подписки на список не отменить и наличие обратимым удалением включен на каждом из ключевых хранилищах.
  
### <a name="backup-azure-key-vault"></a>Помещение резервного копирования Azure ключа
<a name="BackupAzureKeyVaultkeys"> </a>

Сразу после создания или изменения в раздел создания резервной копии и храните резервного копирования и в автономном режиме. Автономные копии не должен быть подключен к сети, такие как физическое хранилище безопасных или коммерческие услуг. По крайней мере одна копия резервного копирования должны храниться в папке, которая будет доступна в случае аварии. Резервного копирования большие двоичные объекты являются единственным способом восстановления материала ключа следует ключ помещение ключ безвозвратно потеряны или в противном случае отображается из строя. Ключи, внешними по отношению к помещение ключ Azure и завершен хранилище ключа Azure не связаны для резервного копирования, так как метаданные, необходимые для ключа клиента для использования ключа не существует с помощью внешнего ключа. Только резервной копии, созданной из хранилища Azure ключ может использоваться для выполнения операций восстановления с ключом клиента. Очень важно сделать резервную копию ключа хранилище Azure загружаться или создав ключа.
  
Чтобы создать резервную копию ключа помещение ключ Azure, выполните командлет [AzureKeyVaultKey резервного копирования](https://docs.microsoft.com/powershell/module/AzureRM.KeyVault/Backup-AzureKeyVaultKey) следующим образом:
```
Backup-AzureKeyVaultKey -VaultName <vaultname> -Name <keyname> 
-OutputFile <filename .backup>

```

Убедитесь, что в выходной файл используется суффикс `.backup`.
  
Выходной файл, результатом этого командлета шифрования и не может использоваться за пределами Azure ключ хранилище. Резервная копия восстанавливаются только с подпиской Azure, из которого была создана резервная копия.
  
> [!TIP]
> Для файла вывода выберите сочетание помещение имя и имя ключа. Это делает имя файла собственное описание. Он также гарантирует, что имена файла резервной копии не перекрывались. 
  
Пример:
  
```
Backup-AzureKeyVaultKey -VaultName Contoso-O365EX-NA-VaultA1 -Name Contoso-O365EX-NA-VaultA1-Key001 -OutputFile Contoso-O365EX-NA-VaultA1-Key001-Backup-20170802.backup
```

### <a name="validate-azure-key-vault-configuration-settings"></a>Проверка параметров конфигурации помещение ключ Azure
<a name="Validateconfiguration"> </a>

Для выполнения проверки перед использованием ключей в DEP является обязательным, но настоятельно рекомендуется. В частности при использовании действия для настройки ключей и хранилищами отличным от из них, описанных в этом разделе должно проверять работоспособности ресурсов хранилище Azure ключа перед настройкой ключа клиента.
  
Чтобы убедитесь, что ключи операции get, wrapKey и unwrapKey включено:
  
Используйте командлет [Get-AzureRmKeyVault](https://docs.microsoft.com/powershell/module/AzureRM.KeyVault/Get-AzureRmKeyVault) следующим образом: 
  
```
Get-AzureRMKeyVault -VaultName <vaultname>
```

В выходных данных найдите для политики доступа и Exchange Online идентификатор (GUID) или SharePoint Online идентификатор (GUID) соответствующим образом. Все три выше разрешения должны отображаться в области разрешения для ключей.
  
Неправильная настройка политики доступа, выполните командлет Set-AzureRmKeyVaultAccessPolicy следующим образом:
  
```
Set-AzureRmKeyVaultAccessPolicy -VaultName <vaultname> -PermissionsToKeys wrapKey,unwrapKey,get -ServicePrincipalName <Office 365 appID>
```

Например для Exchange Online и Скайп для бизнеса:
  
```
Set-AzureRmKeyVaultAccessPolicy -VaultName Contoso-O365EX-NA-VaultA1 
-PermissionsToKeys wrapKey,unwrapKey,get -ServicePrincipalName 00000002-0000-0ff1-ce00-000000000000
```

Например для SharePoint Online и OneDrive для бизнеса:
  
```
Set-AzureRmKeyVaultAccessPolicy -VaultName Contoso-O365SP-NA-VaultA1 
-PermissionsToKeys wrapKey,unwrapKey,get -ServicePrincipalName TBD
```

Чтобы убедиться, что дату окончания срока действия не установлен для ключей выполните командлет [Get-AzureKeyVaultKey](https://docs.microsoft.com/powershell/module/AzureRM.KeyVault/Get-AzureKeyVaultKey) следующим образом: 
  
```
Get-AzureKeyVaultKey -VaultName <vaultname> 
```

Просроченные ключа не может использоваться с ключом клиента и попытка с истекшим сроком действия ключом операции с ошибкой и привести к в недоступности службы. Мы настоятельно рекомендуем, клавиши, которые используются с ключом клиента нет дату окончания срока действия. Срок действия, после набора, не может быть удалена, но может быть изменено на другую дату. Если ключ должен использоваться с датой истечения срока действия задайте, измените значение срока действия 12/31/9999. Клавиши со сроком значение даты, отличное от 12/31/9999 не пройдет проверку Office 365.
  
Чтобы изменить дату окончания срока действия, который имеет значение для любого значения, кроме 12/31/9999, выполните командлет [Set-AzureKeyVaultKeyAttribute](https://docs.microsoft.com/powershell/module/AzureRM.KeyVault/Set-AzureKeyVaultKeyAttribute) следующим образом: 
  
```
Set-AzureKeyVaultKeyAttribute -VaultName <vaultname> -Name <keyname> 
-Expires (Get-Date -Date "12/31/9999")
```

> [!CAUTION]
> Не задавать даты окончания срока действия ключами шифрования, используемого с ключом клиента. 
  
### <a name="obtain-the-uri-for-each-azure-key-vault-key"></a>Получение URI для каждого ключа помещение ключ Azure
<a name="GetKeyURI"> </a>

После выполнить все действия, описанные в Azure для настройки ключа хранилищах и добавлена ключи, выполните следующую команду для получения URI для ключа в каждой ключевые хранилище. Вам потребуется использовать эти коды URI, при создании и назначение каждого DEP более поздних версий, поэтому сохраните эти сведения в надежном месте. Не забудьте выполнить эту команду один раз для каждого ключа хранилище.
  
В Azure PowerShell:
  
```
(Get-AzureKeyVaultKey -VaultName <vaultname>).Id
```

## <a name="office-365-setting-up-customer-key-for-exchange-online-and-skype-for-business"></a>Office 365: Настройка ключа клиента для Exchange Online и Скайп для бизнеса
<a name="AzureSteps"> </a>

Прежде чем начать, убедитесь, что вы выполнили действия, необходимые для настройки помещение ключ Azure. Дополнительные сведения содержатся [завершения задачи в хранилище ключа Azure и она Microsoft для ключа клиента](controlling-your-data-using-customer-key.md#AzureSteps) . 
  
Для настройки ключа клиента для Exchange Online и Скайп для бизнеса, необходимо выполнить следующие действия с помощью удаленного подключения к Exchange Online с помощью Windows PowerShell.
  
### <a name="create-a-data-encryption-policy-dep-for-use-with-exchange-online-and-skype-for-business"></a>Создание политики шифрования данных (DEP) для использования с Exchange Online и Скайп для бизнеса
<a name="CreateDEP4EXOSkype"> </a>

Предотвращение выполнения данных связан с набор разделов, хранящиеся в хранилище Azure ключ. Назначьте DEP почтового ящика в Office 365. Office 365 будет использовать клавишам в политике для шифрования почтового ящика. Чтобы создать DEP, необходимо коды URI помещение ключ, полученный ранее. В разделе [получить URI для каждого ключа Azure ключ помещение](controlling-your-data-using-customer-key.md#GetKeyURI) инструкции. 
  
Не забудьте! При создании DEP, задается два разделы, которые находятся в двух различных хранилищах ключ Azure. Убедитесь, что эти разделы находятся в двух разных регионов Azure для обеспечения избыточности географически.
  
Чтобы создать DEP, выполните следующие действия.
  
1. На локальном компьютере с помощью рабочего или школы учетной записи, имеющей права глобального администратора в организации Office 365, [подключение к Exchange Online PowerShell](https://technet.microsoft.com/en-us/library/jj984289%28v=exchg.160%29.aspx) , выполнив следующую команду Windows PowerShell. 
    
   ```
   $UserCredential = Get-Credential
   ```

2. В диалоговом окне запрос учетных данных Windows PowerShell введите работу или школе сведений об учетной записи, нажмите **кнопку ОК**и введите следующую команду. 
    
   ```
   $Session = New-PSSession -ConfigurationName Microsoft.Exchange -ConnectionUri https://outlook.office365.com/powershell-liveid/ -Credential $UserCredential -Authentication Basic -AllowRedirection
   ```

3. Выполните следующую команду.
    
   ```
   Import-PSSession $Session
   ```

4. Чтобы создать DEP, командлет New-DataEncryptionPolicy, введя следующую команду.
    
   ```
   New-DataEncryptionPolicy -Name <PolicyName> -Description "PolicyDescription " -AzureKeyIDs <KeyVaultURI1>, <KeyVaultURI2>
   ```

   Где:
    
   -  *PolicyName* — это имя, которое будет использоваться для политики. Имена не могут содержать пробелов. Например USA_mailboxes. 
    
   -  *PolicyDescription* — это понятное описание политики, которая поможет вам Имейте в виду, что политики для. В описании могут содержать пробелов. Например корневой ключ для почтовых ящиков в США и их территорий. 
    
   -  *KeyVaultURI1* — это URI для первого ключа в политике. Например https://contoso_EastUSvault01.vault.azure.net/keys/USA_key_01. 
    
   -  *KeyVaultURI2* — это URI для второго ключа в политике. Например https://contoso_EastUS2vault01.vault.azure.net/keys/USA_Key_02. Для разделения двух URI с запятой и пробелом. 
    
   Пример.
  
   ```
   New-DataEncryptionPolicy -Name USA_mailboxes -Description "Root key for mailboxes in USA and its territories" -AzureKeyIDs https://contoso_EastUSvault01.vault.azure.net/keys/USA_key_01, https://contoso_EastUS2vault01.vault.azure.net/keys/USA_Key_02
   ```

### <a name="assign-a-dep-to-a-mailbox"></a>Назначение DEP почтовому ящику
<a name="assignDEPtomailbox"> </a>

Назначение DEP почтовому ящику с помощью командлета Set-Mailbox. После того как политики, Office 365 зашифровывать почтового ящика с ключом, указанный в функции.
  
```
Set-Mailbox -Identity <MailboxIdParameter> -DataEncryptionPolicy <PolicyName>
```

Где *MailboxIdParameter* указывает почтовый ящик. Дополнительные сведения о командлет Set-Mailbox можно [Set-Mailbox](https://technet.microsoft.com/library/bb123981%28v=exchg.160%29.aspx).
  
### <a name="validate-mailbox-encryption"></a>Проверка шифрования почтовых ящиков
<a name="validatemailboxencryption"> </a>

Шифрование почтового ящика может занять некоторое время. Для назначения политики первый раз перед службу зашифровывать почтового ящика почтового ящика необходимо выполнить перемещение из одной базы данных на другой. Корпорация Майкрософт рекомендует отложить 72 часа перед выполнением проверки шифрования после изменения DEP или впервые DEP назначить почтовому ящику.
  
Командлет Get-MailboxStatistics для определения, если шифруется почтового ящика.
  
```
Get-MailboxStatistics -Identity <GeneralMailboxOrMailUserIdParameter> | fl IsEncrypted
```

Свойство IsEncrypted возвращает значение **true** при шифровании почтового ящика и значение **false** , если почтовый ящик не зашифрованы. 

Время для завершения перемещения почтовых ящиков зависит от того, количество почтовых ящиков, к которым нужно назначить DEP в первый раз, а также размер почтовых ящиков. Если почтовые ящики не зашифрованных после недели с момента назначен DEP, инициировать перемещения почтовых ящиков для зашифрованных почтовых ящиков с помощью командлета New-MoveRequest.

```
New-MoveRequest <mailbox alias>
``` 

## <a name="office-365-setting-up-customer-key-for-sharepoint-online-and-onedrive-for-business"></a>Office 365: Настройка ключа клиента для SharePoint Online и OneDrive для бизнеса
<a name="AzureSteps"> </a>

Прежде чем начать, убедитесь, что вы выполнили действия, необходимые для настройки помещение ключ Azure. Дополнительные сведения содержатся [завершения задачи в хранилище ключа Azure и она Microsoft для ключа клиента](controlling-your-data-using-customer-key.md#AzureSteps) . 
  
Чтобы настроить ключ клиента для SharePoint Online и OneDrive для бизнеса, необходимо выполнить эти шаги удаленно подключается к SharePoint Online с помощью Windows PowerShell.
  
### <a name="create-a-data-encryption-policy-dep-for-each-sharepoint-online-and-onedrive-for-business-geo"></a>Создание политики шифрования данных (DEP) для каждого SharePoint Online и OneDrive для бизнеса географически
<a name="CreateDEP4SPOODfB"> </a>

Предотвращение выполнения данных связан с набор разделов, хранящиеся в хранилище Azure ключ. Функция DEP применяется для всех данных в одной географическому положению, также называемый географически. Если функция несколькими географически Office 365 (в настоящее время в предварительной версии), можно создать одну DEP на географически. Если вы не используете несколькими географически, можно создать одну DEP в Office 365 для использования с SharePoint Online и OneDrive для бизнеса. Office 365 будет использовать клавишам в DEP для шифрования данных в этой географически. Чтобы создать DEP, необходимо коды URI помещение ключ, полученный ранее. В разделе [получить URI для каждого ключа Azure ключ помещение](controlling-your-data-using-customer-key.md#GetKeyURI) инструкции. 
  
Не забудьте! При создании DEP, задается два разделы, которые находятся в двух различных хранилищах ключ Azure. Убедитесь, что эти разделы находятся в двух разных регионов Azure для обеспечения избыточности географически.
  
Для создания DEP, необходимо подключиться к SharePoint Online с помощью Windows PowerShell.
  
1. На локальном компьютере с помощью рабочего или школы учетной записи, имеющей права глобального администратора в организации Office 365, [подключиться к SharePoint Online Powershell](https://technet.microsoft.com/library/fp161372.aspx).
    
2. В Microsoft SharePoint Online командной консоли выполните командлет [Register-SPODataEncryptionPolicy](https://technet.microsoft.com/library/mt843950.aspx) следующим образом: 
    
   ```
   Register-SPODataEncryptionPolicy -Identity <SPOAdminSiteUrl> -PrimaryKeyVaultName <PrimaryKeyVaultName> -PrimaryKeyName <PrimaryKeyName> -PrimaryKeyVersion <PrimaryKeyVersion> -SecondaryKeyVaultName <SecondaryKeyVaultName> -SecondaryKeyName <SecondaryKeyName> -SecondaryKeyVersion <SecondaryKeyVersion>
   ```

   При регистрации DEP шифрования начинается с данными в географически. Этот процесс может занять некоторое время.
    
### <a name="validate-encryption-of-group-sites-team-sites-and-onedrive-for-business"></a>Проверка шифрования группы сайтов, веб-сайтов групп и OneDrive для бизнеса
<a name="validateencryptionSPO"> </a>

Вы можете проверить состояние шифрования с помощью командлета Get-SPODataEncryptionPolicy следующим образом:
  
```
Get-SPODataEncryptionPolicy -Identity <SPOAdminSiteUrl>
```

Выходные данные этот командлет включает в себя:
  
- URI первичный ключ.
    
- URI дополнительный ключ.
    
- Состояние шифрования для географически. Следующие возможные состояния.
    
  - **Незарегистрированных:** Ключ шифрования клиента еще не были применены. 
    
  - **Регистрации:** Клиент ключ шифрования был применен и файлы находятся в процессе выполнения шифрования. Если ваше географически это состояние означает, вы также показывается сведения на какой процент сайтов в географически завершены, таким образом, можно отслеживать ход выполнения шифрования. 
    
  - **Зарегистрирован:** Клиент ключ шифрования был применен и зашифрованных все файлы всех веб-сайтов. 
    
  - **Ваши:** Ключевые путем развертывания находится в стадии разработки. Если ваше географически это состояние, вы также показывается сведения на какой процент сайты выполнить операцию ключевые ролл (en) таким образом, можно отслеживать ход выполнения. 
    
## <a name="managing-customer-key-for-office-365"></a>Управление ключом клиента для Office 365
<a name="ManageCustomerKey"> </a>

После настройки ключа клиента Office 365, можно выполнить эти задачи дополнительное управление.
  
- [Восстановление ключа хранилище Azure разделов](controlling-your-data-using-customer-key.md#RestoreAzureKeyVaultKeys)
    
- [Ваши или вращающимся ключа в хранилище Azure ключ, используйте с ключом клиента](controlling-your-data-using-customer-key.md#RollCKkey)
    
- [Управление разрешениями для ключа хранилище](controlling-your-data-using-customer-key.md#Managekeyvaultperms)
    
- [Определение DEP, назначенных почтовому ящику](controlling-your-data-using-customer-key.md#DeterminemailboxDEP)
    
### <a name="restore-azure-key-vault-keys"></a>Восстановление ключа хранилище Azure разделов
<a name="RestoreAzureKeyVaultKeys"> </a>

Перед выполнением восстановления, используйте возможности восстановления, предоставляемые обратимым удалением. Все разделы, которые используются с ключом клиента должны иметь обратимым удалением включен. Обратимым удалением действует как recycle bin и разрешает восстановление до 90 дней без необходимости восстановления. Восстановление должно быть необходимо только в условиях чрезмерную или нестандартный, например если ключ или ключевые помещение теряется. Если необходимо восстановить ключ для использования с ключом клиента в Azure PowerShell используйте командлет Restore-AzureKeyVaultKey следующим образом:
  
```
Restore-AzureKeyVaultKey -VaultName <vaultname> -InputFile <filename>
```

Пример:
  
```
Restore-AzureKeyVaultKey -VaultName Contoso-O365EX-NA-VaultA1 -InputFile Contoso-O365EX-NA-VaultA1-Key001-Backup-20170802.backup
```

Если ключ с таким же именем уже существует в хранилище ключа, произойдет сбой операции восстановления. Восстановление AzureKeyVaultKey восстанавливает все основные версии и все метаданные для ключа, включая имя раздела.
  
### <a name="rolling-or-rotating-a-key-in-azure-key-vault-that-you-use-with-customer-key"></a>Ваши или вращающимся ключа в хранилище Azure ключ, используйте с ключом клиента
<a name="RollCKkey"> </a>

Ваши ключи не является обязательным, либо помещение ключ Azure, либо по ключу клиента. Кроме того разделы, защищенные с помощью аппаратного практически невозможно безопасности. Даже в том случае, если были корневой раздел во временном пользовании вредоносных actor нет отсутствуют средства использования для расшифровки данных, поскольку только кода Office 365 может использовать его. Тем не менее ваши ключа поддерживается ключа клиента.
  
> [!CAUTION]
> Только восстановить ключ шифрования, которая будет использоваться с ключом клиента для существует снимите флажок технические причина или требование соответствия определяет, что вам необходимо откатить ключ. Кроме того не удаляйте разделы, или были связаны с политиками. Если ключи, будут содержимое зашифрован с предыдущих разделов. К примеру во время активной почтовые ящики будут зашифрованы заново часто, неактивных, отключенные и отключенных почтовых ящиков может по-прежнему зашифрован с предыдущих разделов. SharePoint Online выполняет резервное копирование содержимого для целей восстановления и восстановления, поэтому может быть по-прежнему архивных контента с использованием старых ключей.<br/> Чтобы обеспечить безопасность данных, SharePoint Online позволяет не более одной операции отката ключ к обработке за раз. Если вам нужно развертывать оба разделов ключевые так, вам будет ожидать первого операции ключа roll полностью завершена. Мы рекомендуем является составляйте работы ключевых roll с разными интервалами, чтобы эта проблема не возникает. 
  
Если ключ, вы запрашиваете новой версии существующего ключа. Чтобы запросить новую версию существующий раздел, используйте же командлет [Add-AzureKeyVaultKey](https://docs.microsoft.com/powershell/module/AzureRM.KeyVault/Add-AzureKeyVaultKey)с тем же синтаксисом, который использовался для создания ключа в первую очередь.
  
Пример:
  
```
Add-AzureKeyVaultKey -VaultName Contoso-O365EX-NA-VaultA1 -Name Contoso-O365EX-NA-VaultA1-Key001 -Destination HSM -KeyOps @('wrapKey','unwrapKey') -NotBefore (Get-Date -Date "12/27/2016 12:01 AM")
```

В этом примере ключ с именем **Contoso-O365EX-NA-VaultA1-Key001** уже существует в **Contoso-O365EX-NA-VaultA1** помещение нового ключа версии создается. Операция добавляет новую версию ключа. Эта операция сохраняет предыдущих версий ключа в раздел: журнал версий, таким образом, по-прежнему можно расшифровать данные, зашифрованные с помощью этого ключа. После завершения развертывания любую клавишу, который связан с DEP необходимо снова запустить дополнительные командлет, чтобы убедиться, что ключ клиента начинается с помощью нового ключа. 
  
#### <a name="enable-exchange-online-and-skype-for-business-to-use-a-new-key-after-you-roll-or-rotate-keys-in-azure-key-vault"></a>Разрешить Exchange Online и Скайп для бизнеса, чтобы использовать новый ключ после отката или поворот ключей в хранилище ключа Azure

Если любой из ключи помещение ключ Azure, связанного с DEP используется с Exchange Online и Скайп для бизнеса, необходимо выполнить следующую команду, чтобы обновить DEP и включить Office 365 начать работу с использованием нового ключа.
  
Чтобы указать ключ клиента для использования нового ключа шифрования почтовых ящиков в Office 365, выполните командлет Set-DataEncryptionPolicy следующим образом:
  
```
Set-DataEncryptionPolicy <policyname> -Refresh 
```

В течение 48 часов станет связанное с ключом обновленные active почтовые ящики, зашифрованные с помощью этой политики. Выполните действия в [Определение DEP, назначенных почтовому ящику](controlling-your-data-using-customer-key.md#DeterminemailboxDEP) для проверки значения для свойства DataEncryptionPolicyID для почтового ящика. Значение для этого свойства будет изменить, когда была применена обновленный ключ. 
  
#### <a name="enable-sharepoint-online-and-onedrive-for-business-to-use-a-new-key-after-you-roll-or-rotate-keys-in-azure-key-vault"></a>Включение SharePoint Online и OneDrive для бизнеса использовать новый ключ после отката или поворот ключей в хранилище ключа Azure

Если любой из ключи помещение ключ Azure, связанного с DEP используется с SharePoint Online и OneDrive для бизнеса, необходимо запустить командлет [Update-SPODataEncryptionPolicy](https://technet.microsoft.com/library/mt843948.aspx) для обновления DEP и включить Office 365 начать работу с использованием нового ключа. 
  
```
Update-SPODataEncryptionPolicy -Identity <SPOAdminSiteUrl> -KeyVaultName <ReplacementKeyVaultName> -KeyName <ReplacementKeyName> -KeyVersion <ReplacementKeyVersion> -KeyType <Primary | Secondary>
```

Будет запущен ключевых roll операции для SharePoint Online и OneDrive для бизнеса. Это действие не интерпретации. Для просмотра хода выполнения ключа откатить операции, выполните командлет Get-SPODataEncryptionPolicy следующим образом:
  
```
Get-SPODataEncryptionPolicy -Identity <SPOAdminSiteUrl>
```

### <a name="manage-key-vault-permissions"></a>Управление разрешениями для ключа хранилище
<a name="Managekeyvaultperms"> </a>

Доступны несколько командлеты, позволяющие просматривать и при необходимости удаления ключа помещение разрешений. Может понадобиться для удаления разрешений, например, когда сотрудник покидает группу.
  
Для ключа помещение разрешения на просмотр, выполните командлет Get-AzureRmKeyVault:
  
```
Get-AzureRmKeyVault -VaultName <vaultname>
```

Пример:
  
```
Get-AzureRmKeyVault -VaultName Contoso-O365EX-NA-VaultA1
```

Чтобы удалить разрешения администратора, выполните командлет Remove-AzureRmKeyVaultAccessPolicy:
  
```
Remove-AzureRmKeyVaultAccessPolicy -VaultName <vaultname> 
-UserPrincipalName <UPN of user>
```

Пример:
  
```
Remove-AzureRmKeyVaultAccessPolicy -VaultName Contoso-O365EX-NA-VaultA1 
-UserPrincipalName alice@contoso.com
```

### <a name="determine-the-dep-assigned-to-a-mailbox"></a>Определение DEP, назначенных почтовому ящику
<a name="DeterminemailboxDEP"> </a>

Чтобы определить DEP, назначенных почтовому ящику, используйте командлет Get-MailboxStatistics. Командлет возвращает уникальный идентификатор (GUID).
  
```
Get-MailboxStatistics -Identity <GeneralMailboxOrMailUserIdParameter> | fl DataEncryptionPolicyID
```

Где *GeneralMailboxOrMailUserIdParameter* указывает почтовый ящик. Дополнительные сведения о командлет Get-MailboxStatistics можно [Get-MailboxStatistics](https://technet.microsoft.com/library/bb124612%28v=exchg.160%29.aspx).
  
Используйте идентификатор GUID для получения понятное имя DEP, назначенных почтовому ящику, выполнив следующий командлет.
  
```
Get-DataEncryptionPolicy <GUID>
```

Где *GUID* — это идентификатор GUID, возвращаемых командлетом Get-MailboxStatistics в предыдущем шаге. 
  

